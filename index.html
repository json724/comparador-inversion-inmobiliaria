<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparación de Inversión Inmobiliaria</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <link rel="shortcut icon" href="assets/favicon/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .custom-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 0.5rem; overflow: hidden; }
        .custom-table th, .custom-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; }
        .custom-table th { background-color: #f9fafb; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; }
        .custom-table td { color: #4b5563; }
        .custom-table tbody tr:last-child td { border-bottom: none; }
        .custom-table tfoot tr td { font-weight: 600; background-color: #f3f4f6; }
        .custom-table tbody tr:hover { background-color: #f3f4f6; }

        @media (max-width: 1024px) { .custom-table th, .custom-table td { font-size: 0.75rem; padding: 0.5rem 0.75rem; } }
        @media (max-width: 768px) { .custom-table th, .custom-table td { font-size: 0.7rem; padding: 0.4rem 0.5rem; } }

        h2.section-title { font-size: 1.75rem; font-weight: 700; color: #1e40af; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #93c5fd; padding-bottom: 0.5rem; }
        h3.subsection-title { font-size: 1.25rem; font-weight: 600; color: #1d4ed8; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        h4.section-subtitle { font-size: 1rem; font-weight: 600; color: #374151; margin-top: 1.25rem; margin-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.375rem; }
        h5.table-title { font-size: 1.1rem; font-weight: 600; color: #1e3a8a; margin-top: 1.5rem; margin-bottom: 0.75rem; }

        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .input-group input[type="number"], .input-group input[type="range"] { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        .input-group input[type="range"] { padding: 0; height: 1.25rem; cursor: pointer; }

        .slider-value { font-weight: 500; color: #1d4ed8; min-width: 3em; text-align: right; }
        .calculated-summary-item { font-size: 0.875rem; color: #374151; margin-bottom: 0.25rem; }
        .calculated-summary-item .value { font-weight: 600; color: #1d4ed8; }

        .positive-diff { color: #16a34a; font-weight: 500; }
        .negative-diff { color: #dc2626; font-weight: 500; }
        .hidden-section { display: none; }

        .summary-block { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .summary-block h4 { font-size: 1.1rem; font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; }
        .summary-block ul { list-style: none; padding-left: 0; }
        .summary-block li { font-size: 0.875rem; color: #4b5563; margin-bottom: 0.375rem; }
        .summary-block li strong { color: #374151; }
        .summary-block .value { font-weight: 600; color: #1d4ed8; }
        .summary-block .note { font-size: 0.75rem; color: #6b7280; margin-top: 0.75rem; font-style: italic; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">
    <div class="container mx-auto max-w-full xl:max-w-7xl bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700 mb-4">
                Comparador Financiero de Proyectos Inmobiliarios
            </h1>
            <p class="text-gray-600 text-md md:text-lg max-w-3xl mx-auto">
                Configure los parámetros y compare la rentabilidad de invertir en uno o dos proyectos inmobiliarios frente a instrumentos financieros líquidos.
            </p>
        </header>

        <section class="mb-10 p-6 bg-blue-50 rounded-xl shadow-lg border border-blue-200">
            <h2 class="text-2xl font-semibold text-blue-700 mb-6 border-b-2 border-blue-200 pb-2">Configuración de Parámetros</h2>

            <div class="mb-6">
                <label class="block text-lg font-semibold text-blue-700 mb-2">Número de Proyectos a Analizar:</label>
                <div class="flex items-center space-x-4">
                    <label for="oneProjectRadio" class="flex items-center cursor-pointer">
                        <input type="radio" id="oneProjectRadio" name="projectCount" value="1" class="form-radio h-5 w-5 text-blue-600" checked>
                        <span class="ml-2 text-gray-700">Un Proyecto</span>
                    </label>
                    <label for="twoProjectsRadio" class="flex items-center cursor-pointer">
                        <input type="radio" id="twoProjectsRadio" name="projectCount" value="2" class="form-radio h-5 w-5 text-blue-600">
                        <span class="ml-2 text-gray-700">Dos Proyectos</span>
                    </label>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-8 mb-6">
                <div id="project1InputBlock" class="p-4 bg-white rounded-lg shadow border border-gray-200">
                    <h3 class="text-lg font-semibold text-blue-600 mb-3">Proyecto 1</h3>
                    <div class="input-group">
                        <label for="project1BaseValueInput">Valor Inmueble (Base) (COP):</label>
                        <input type="number" id="project1BaseValueInput" value="227000000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project1InitialMonthlyRent">Arriendo Mensual Inicial (COP):</label>
                        <input type="number" id="project1InitialMonthlyRent" value="1400000" class="mt-1">
                    </div>

                    <h4 class="section-subtitle">Gastos Anuales del Inmueble</h4>
                    <div class="input-group">
                        <label for="project1PropertyTaxPercent">Impuesto Predial (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project1PropertyTaxPercent" value="0.5" step="0.01" min="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project1MaintenancePercent">Mantenimiento (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project1MaintenancePercent" value="1" step="0.01" min="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project1InsurancePercent">Seguro de Vivienda (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project1InsurancePercent" value="0.3" step="0.01" min="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project1AdminFeeMonthly">Administración (COP Mensual Inicial):</label>
                        <input type="number" id="project1AdminFeeMonthly" value="0" class="mt-1">
                    </div>

                    <h4 class="section-subtitle">Financiamiento</h4>
                    <div class="input-group">
                        <label for="project1DownPaymentPercent">Porcentaje de Entrada (% sobre Valor Total con Notaría):</label>
                        <input type="number" id="project1DownPaymentPercent" value="30" min="0" max="100" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project1CreditRate">Tasa E.A. Crédito (%):</label>
                        <input type="number" id="project1CreditRate" value="12" step="0.01" class="mt-1" min="0" max="100">
                    </div>

                    <div class="mt-3 text-xs text-gray-700">
                        <h4 class="section-subtitle !mt-0 !mb-1 !text-sm">Resumen Costos (Calculado):</h4>
                        <div class="pl-2 mb-2 border-l-2 border-blue-200">
                            <h5 class="font-medium text-gray-600 text-xs">Costos Iniciales:</h5>
                            <ul class="list-none ml-2 space-y-0.5">
                                <li class="calculated-summary-item">Monto Gastos Notaría: <span id="project1NotaryAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Valor Total con Notaría: <span id="project1TotalValueWithNotaryDisplay_Config" class="value"></span></li>
                            </ul>
                        </div>
                        <div class="pl-2 border-l-2 border-blue-200">
                            <h5 class="font-medium text-gray-600 text-xs">Detalles del Crédito:</h5>
                            <ul class="list-none ml-2 space-y-0.5">
                                <li class="calculated-summary-item">Enganche Calculado: <span id="project1DownPaymentAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Valor a Financiar: <span id="project1LoanAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Total Intereses Pagados (Estimado): <span id="project1TotalInterestDisplay_Config" class="value"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="project2InputBlock" class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden-section">
                    <h3 class="text-lg font-semibold text-blue-600 mb-3">Proyecto 2</h3>
                    <div class="input-group">
                        <label for="project2BaseValueInput">Valor Inmueble (Base) (COP):</label>
                        <input type="number" id="project2BaseValueInput" value="408000000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project2InitialMonthlyRent">Arriendo Mensual Inicial (COP):</label>
                        <input type="number" id="project2InitialMonthlyRent" value="1900000" class="mt-1">
                    </div>

                    <h4 class="section-subtitle">Gastos Anuales del Inmueble</h4>
                    <div class="input-group">
                        <label for="project2PropertyTaxPercent">Impuesto Predial (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project2PropertyTaxPercent" value="0.5" step="0.01" min="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project2MaintenancePercent">Mantenimiento (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project2MaintenancePercent" value="1" step="0.01" min="0" class="mt-1">
                    </div>
                     <div class="input-group">
                        <label for="project2InsurancePercent">Seguro de Vivienda (% sobre Valor Inmueble Base Anual):</label>
                        <input type="number" id="project2InsurancePercent" value="0.3" step="0.01" min="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project2AdminFeeMonthly">Administración (COP Mensual Inicial):</label>
                        <input type="number" id="project2AdminFeeMonthly" value="0" class="mt-1">
                    </div>

                    <h4 class="section-subtitle">Financiamiento</h4>
                     <div class="input-group">
                        <label for="project2DownPaymentPercent">Porcentaje de Entrada (% sobre Valor Total con Notaría):</label>
                        <input type="number" id="project2DownPaymentPercent" value="30" min="0" max="100" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="project2CreditRate">Tasa E.A. Crédito (%):</label>
                        <input type="number" id="project2CreditRate" value="12" step="0.01" class="mt-1" min="0" max="100">
                    </div>

                    <div class="mt-3 text-xs text-gray-700">
                        <h4 class="section-subtitle !mt-0 !mb-1 !text-sm">Resumen Costos (Calculado):</h4>
                        <div class="pl-2 mb-2 border-l-2 border-blue-200">
                            <h5 class="font-medium text-gray-600 text-xs">Costos Iniciales:</h5>
                            <ul class="list-none ml-2 space-y-0.5">
                                <li class="calculated-summary-item">Monto Gastos Notaría: <span id="project2NotaryAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Valor Total con Notaría: <span id="project2TotalValueWithNotaryDisplay_Config" class="value"></span></li>
                            </ul>
                        </div>
                        <div class="pl-2 border-l-2 border-blue-200">
                            <h5 class="font-medium text-gray-600 text-xs">Detalles del Crédito:</h5>
                            <ul class="list-none ml-2 space-y-0.5">
                                <li class="calculated-summary-item">Enganche Calculado: <span id="project2DownPaymentAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Valor a Financiar: <span id="project2LoanAmountDisplay_Config" class="value"></span></li>
                                <li class="calculated-summary-item">Total Intereses Pagados (Estimado): <span id="project2TotalInterestDisplay_Config" class="value"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg shadow border border-gray-200" id="generalFinancialBlock">
                    <h3 class="text-lg font-semibold text-blue-600 mb-3">Generales y Financieros</h3>
                    <div class="input-group">
                        <label for="investmentYearsSlider" class="flex justify-between items-center">
                           <span>Años de Inversión:</span>
                           <span id="investmentYearsValue" class="slider-value">10</span>
                        </label>
                        <input type="range" id="investmentYearsSlider" value="10" min="0" max="50" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="loanTermYearsSlider" class="flex justify-between items-center">
                           <span>Plazo Crédito (Años):</span>
                           <span id="loanTermYearsValue" class="slider-value">10</span>
                        </label>
                        <input type="range" id="loanTermYearsSlider" value="10" min="0" max="50" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="notaryFeesPercentInput">Gastos Notaría y Registro (% sobre Valor Base):</label>
                        <input type="number" id="notaryFeesPercentInput" value="2.5" step="0.01" min="0" max="20" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="inflationRateInput">Inflación Estimada Anual (%):</label>
                        <input type="number" id="inflationRateInput" value="5" step="0.1" class="mt-1" min="-100" max="100">
                    </div>
                    <div class="input-group">
                        <label for="fpvRateInput">Tasa FPV (% E.A.):</label>
                        <input type="number" id="fpvRateInput" value="8.68" step="0.01" class="mt-1" min="-100" max="100">
                    </div>
                    <div class="input-group">
                        <label for="highYieldFundRateInput">Tasa Fondo Alta Rent. (% E.A.):</label>
                        <input type="number" id="highYieldFundRateInput" value="14.61" step="0.01" class="mt-1" min="-100" max="100">
                    </div>
                </div>

                <div class="md:col-span-2 lg:col-span-3 p-4 bg-white rounded-lg shadow border border-gray-200">
                    <h3 class="text-lg font-semibold text-blue-600 mb-4">Escenarios de Valorización Anual Inmueble (% sobre Valor Base)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="input-group">
                            <label for="pessimisticRateSlider" class="flex justify-between items-center">
                                <span>Pesimista:</span>
                                <span id="pessimisticRateValue" class="slider-value">2.5%</span>
                            </label>
                            <input type="range" id="pessimisticRateSlider" min="-10" max="20" value="2.5" step="0.1" class="mt-1">
                        </div>
                        <div class="input-group">
                            <label for="normalRateSlider" class="flex justify-between items-center">
                                <span>Normal:</span>
                                <span id="normalRateValue" class="slider-value">5.0%</span>
                            </label>
                            <input type="range" id="normalRateSlider" min="-10" max="20" value="5.0" step="0.1" class="mt-1">
                        </div>
                        <div class="input-group">
                            <label for="realisticRateSlider" class="flex justify-between items-center">
                                <span>Realista:</span>
                                <span id="realisticRateValue" class="slider-value">6.5%</span>
                            </label>
                            <input type="range" id="realisticRateSlider" min="-10" max="20" value="6.5" step="0.1" class="mt-1">
                        </div>
                        <div class="input-group">
                            <label for="optimisticRateSlider" class="flex justify-between items-center">
                                <span>Optimista:</span>
                                <span id="optimisticRateValue" class="slider-value">7.9%</span>
                            </label>
                            <input type="range" id="optimisticRateSlider" min="-10" max="20" value="7.9" step="0.1" class="mt-1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8">
                <button id="calculateButton"
                        class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg transform hover:scale-105">
                    Calcular Simulación
                </button>
                <button id="resetButton"
                        class="ml-4 px-8 py-3 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-150 ease-in-out text-lg transform hover:scale-105">
                    Resetear
                </button>
            </div>
            <div id="errorMessage" class="mt-4 text-red-600 font-semibold text-sm text-center"></div>
        </section>

        <main id="resultsArea" class="space-y-12">
            </main>
    </div>

    <script src="config.js"></script>
    <script>
        // Formatters
        const copFormatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const percentFormatter = (value, decimals = 2) => {
            if (isNaN(value) || !isFinite(value)) return 'N/A';
            return (value * 100).toFixed(decimals) + '%';
        }

        // DOM Elements (grouped by functionality)
        const calculateButton = document.getElementById('calculateButton');
        const resultsArea = document.getElementById('resultsArea');
        const errorMessageDiv = document.getElementById('errorMessage');
        const oneProjectRadio = document.getElementById('oneProjectRadio');
        const twoProjectsRadio = document.getElementById('twoProjectsRadio');

        // General Parameters
        const investmentYearsSlider = document.getElementById('investmentYearsSlider');
        const investmentYearsValue = document.getElementById('investmentYearsValue');
        const loanTermYearsSlider = document.getElementById('loanTermYearsSlider');
        const loanTermYearsValue = document.getElementById('loanTermYearsValue');
        const notaryFeesPercentInput = document.getElementById('notaryFeesPercentInput');
        const inflationRateInput = document.getElementById('inflationRateInput');
        const fpvRateInput = document.getElementById('fpvRateInput');
        const highYieldFundRateInput = document.getElementById('highYieldFundRateInput');

        const generalFinancialBlock = document.getElementById('generalFinancialBlock'); // For layout adjustment

        // Project 1 DOM Elements
        const project1Elements = {
            block: document.getElementById('project1InputBlock'),
            baseValueInput: document.getElementById('project1BaseValueInput'),
            initialMonthlyRentInput: document.getElementById('project1InitialMonthlyRent'),
            propertyTaxPercentInput: document.getElementById('project1PropertyTaxPercent'),
            maintenancePercentInput: document.getElementById('project1MaintenancePercent'),
            insurancePercentInput: document.getElementById('project1InsurancePercent'),
            adminFeeMonthlyInput: document.getElementById('project1AdminFeeMonthly'),
            downPaymentPercentInput: document.getElementById('project1DownPaymentPercent'),
            creditRateInput: document.getElementById('project1CreditRate'),
            notaryAmountDisplay: document.getElementById('project1NotaryAmountDisplay_Config'),
            totalValueWithNotaryDisplay: document.getElementById('project1TotalValueWithNotaryDisplay_Config'),
            downPaymentAmountDisplay: document.getElementById('project1DownPaymentAmountDisplay_Config'),
            loanAmountDisplay: document.getElementById('project1LoanAmountDisplay_Config'),
            totalInterestDisplay: document.getElementById('project1TotalInterestDisplay_Config')
        };

        // Project 2 DOM Elements
        const project2Elements = {
            block: document.getElementById('project2InputBlock'),
            baseValueInput: document.getElementById('project2BaseValueInput'),
            initialMonthlyRentInput: document.getElementById('project2InitialMonthlyRent'),
            propertyTaxPercentInput: document.getElementById('project2PropertyTaxPercent'),
            maintenancePercentInput: document.getElementById('project2MaintenancePercent'),
            insurancePercentInput: document.getElementById('project2InsurancePercent'),
            adminFeeMonthlyInput: document.getElementById('project2AdminFeeMonthly'),
            downPaymentPercentInput: document.getElementById('project2DownPaymentPercent'),
            creditRateInput: document.getElementById('project2CreditRate'),
            notaryAmountDisplay: document.getElementById('project2NotaryAmountDisplay_Config'),
            totalValueWithNotaryDisplay: document.getElementById('project2TotalValueWithNotaryDisplay_Config'),
            downPaymentAmountDisplay: document.getElementById('project2DownPaymentAmountDisplay_Config'),
            loanAmountDisplay: document.getElementById('project2LoanAmountDisplay_Config'),
            totalInterestDisplay: document.getElementById('project2TotalInterestDisplay_Config')
        };

        const scenarioInputs = [
            { slider: document.getElementById('pessimisticRateSlider'), valueDisplay: document.getElementById('pessimisticRateValue'), name: "Pesimista", color: "text-red-600", decimals: 1 },
            { slider: document.getElementById('normalRateSlider'), valueDisplay: document.getElementById('normalRateValue'), name: "Normal", color: "text-yellow-600", decimals: 1 },
            { slider: document.getElementById('realisticRateSlider'), valueDisplay: document.getElementById('realisticRateValue'), name: "Realista", color: "text-green-600", decimals: 1 },
            { slider: document.getElementById('optimisticRateSlider'), valueDisplay: document.getElementById('optimisticRateValue'), name: "Optimista", color: "text-blue-600", decimals: 1 }
        ];

        function updateSliderValueDisplay(slider, valueDisplay, decimals, unit = '%') {
            valueDisplay.textContent = parseFloat(slider.value).toFixed(decimals) + unit;
        }

        scenarioInputs.forEach(scenario => {
            updateSliderValueDisplay(scenario.slider, scenario.valueDisplay, scenario.decimals);
            scenario.slider.addEventListener('input', () => updateSliderValueDisplay(scenario.slider, scenario.valueDisplay, scenario.decimals));
        });

        updateSliderValueDisplay(investmentYearsSlider, investmentYearsValue, 0, ' años');
        investmentYearsSlider.addEventListener('input', () => {
            updateSliderValueDisplay(investmentYearsSlider, investmentYearsValue, 0, ' años');
            triggerFinancingCalculationsUpdate();
        });

        updateSliderValueDisplay(loanTermYearsSlider, loanTermYearsValue, 0, ' años');
        loanTermYearsSlider.addEventListener('input', () => {
            updateSliderValueDisplay(loanTermYearsSlider, loanTermYearsValue, 0, ' años');
            triggerFinancingCalculationsUpdate();
        });

        function calculateAnnualMortgagePayment(P, i, N) {
            if (P <= 0) return 0;
            if (N <= 0) return P;
            if (i === 0 && N > 0) return P / N;
            if (i === 0 && N === 0) return P;
            const annualPayment = P * (i * Math.pow(1 + i, N)) / (Math.pow(1 + i, N) - 1);
            return annualPayment;
        }

        function updateFinancingCalculationsForProject(projectElements, loanTermYearsSliderInput, notaryFeesPercentGlobalInput) {
            const baseValue = parseFloat(projectElements.baseValueInput.value);
            const downPaymentPercent = parseFloat(projectElements.downPaymentPercentInput.value) / 100;
            const creditRate = parseFloat(projectElements.creditRateInput.value) / 100;
            const loanTermYears = parseInt(loanTermYearsSliderInput.value);
            const notaryFeesPercent = parseFloat(notaryFeesPercentGlobalInput.value) / 100;

            let calculatedNotaryAmount = 0;
            let calculatedTotalValueWithNotary = 0;
            let calculatedInitialUserEquity = 0;
            let calculatedLoanAmount = 0;
            let calculatedTotalInterest = 0;

            const defaultText = '-';

            if (isNaN(baseValue) || baseValue <= 0 || !isFinite(baseValue) ||
                isNaN(notaryFeesPercent) || notaryFeesPercent < 0) {

                projectElements.notaryAmountDisplay.textContent = defaultText;
                projectElements.totalValueWithNotaryDisplay.textContent = defaultText;
                projectElements.downPaymentAmountDisplay.textContent = defaultText;
                projectElements.loanAmountDisplay.textContent = defaultText;
                if (projectElements.totalInterestDisplay) projectElements.totalInterestDisplay.textContent = defaultText;

            } else {
                calculatedNotaryAmount = baseValue * notaryFeesPercent;
                calculatedTotalValueWithNotary = baseValue + calculatedNotaryAmount;

                projectElements.notaryAmountDisplay.textContent = copFormatter.format(calculatedNotaryAmount);
                projectElements.totalValueWithNotaryDisplay.textContent = copFormatter.format(calculatedTotalValueWithNotary);

                if (!isNaN(downPaymentPercent) && downPaymentPercent >= 0 && downPaymentPercent <= 1 &&
                    !isNaN(creditRate) && creditRate >= 0 &&
                    !isNaN(loanTermYears) && loanTermYears >= 0) {

                    if (downPaymentPercent === 0) {
                        calculatedInitialUserEquity = 0;
                    } else {
                        calculatedInitialUserEquity = calculatedTotalValueWithNotary * downPaymentPercent;
                    }
                    calculatedLoanAmount = calculatedTotalValueWithNotary - calculatedInitialUserEquity;

                    projectElements.downPaymentAmountDisplay.textContent = copFormatter.format(calculatedInitialUserEquity);
                    projectElements.loanAmountDisplay.textContent = copFormatter.format(calculatedLoanAmount);

                    if (calculatedLoanAmount > 0 && loanTermYears > 0) {
                        const annualPayment = calculateAnnualMortgagePayment(calculatedLoanAmount, creditRate, loanTermYears);
                        calculatedTotalInterest = (annualPayment * loanTermYears) - calculatedLoanAmount;
                        if (projectElements.totalInterestDisplay) projectElements.totalInterestDisplay.textContent = copFormatter.format(calculatedTotalInterest > 0 ? calculatedTotalInterest : 0);
                    } else if (calculatedLoanAmount > 0 && loanTermYears === 0) {
                         if (projectElements.totalInterestDisplay) projectElements.totalInterestDisplay.textContent = copFormatter.format(0);
                    }
                    else {
                        if (projectElements.totalInterestDisplay) projectElements.totalInterestDisplay.textContent = copFormatter.format(0);
                    }
                } else {
                    projectElements.downPaymentAmountDisplay.textContent = defaultText;
                    projectElements.loanAmountDisplay.textContent = defaultText;
                    if (projectElements.totalInterestDisplay) projectElements.totalInterestDisplay.textContent = defaultText;
                }
            }
            return {
                notaryAmount: calculatedNotaryAmount,
                totalValueWithNotary: calculatedTotalValueWithNotary,
                initialUserEquity: calculatedInitialUserEquity,
                loanAmount: calculatedLoanAmount,
                totalInterest: calculatedTotalInterest
            };
        }

        function triggerFinancingCalculationsUpdate() {
            updateFinancingCalculationsForProject(project1Elements, loanTermYearsSlider, notaryFeesPercentInput);
            if (twoProjectsRadio.checked) {
                updateFinancingCalculationsForProject(project2Elements, loanTermYearsSlider, notaryFeesPercentInput);
            }
        }

        oneProjectRadio.addEventListener('change', () => {
            if (oneProjectRadio.checked) {
                project2Elements.block.classList.add('hidden-section');
                generalFinancialBlock.classList.remove('lg:col-start-3');
            }
        });
        twoProjectsRadio.addEventListener('change', () => {
            if (twoProjectsRadio.checked) {
                project2Elements.block.classList.remove('hidden-section');
                 generalFinancialBlock.classList.add('lg:col-start-3');
                 updateFinancingCalculationsForProject(project2Elements, loanTermYearsSlider, notaryFeesPercentInput);
            }
        });

        const allProjectRelatedInputs = [
            project1Elements.baseValueInput, project1Elements.downPaymentPercentInput, project1Elements.creditRateInput,
            project2Elements.baseValueInput, project2Elements.downPaymentPercentInput, project2Elements.creditRateInput,
            notaryFeesPercentInput
        ];

        allProjectRelatedInputs.forEach(input => {
            input.addEventListener('input', triggerFinancingCalculationsUpdate);
        });


        function getProjectInputData(projectElementsContainer, financingData) {
            return {
                baseValue: parseFloat(projectElementsContainer.baseValueInput.value),
                initialMonthlyRent: parseFloat(projectElementsContainer.initialMonthlyRentInput.value),
                propertyTaxPercent: parseFloat(projectElementsContainer.propertyTaxPercentInput.value) / 100,
                maintenancePercent: parseFloat(projectElementsContainer.maintenancePercentInput.value) / 100,
                insurancePercent: parseFloat(projectElementsContainer.insurancePercentInput.value) / 100,
                adminFeeMonthly: parseFloat(projectElementsContainer.adminFeeMonthlyInput.value),
                downPaymentPercent: parseFloat(projectElementsContainer.downPaymentPercentInput.value) / 100,
                creditRate: parseFloat(projectElementsContainer.creditRateInput.value) / 100,
                notaryAmount: financingData.notaryAmount,
                totalValueWithNotary: financingData.totalValueWithNotary,
                initialUserEquity: financingData.initialUserEquity,
                loanAmount: financingData.loanAmount,
                totalInterestPaid: financingData.totalInterest
            };
        }


        function getAndValidateInputs() {
            const p1Financing = updateFinancingCalculationsForProject(project1Elements, loanTermYearsSlider, notaryFeesPercentInput);
            let p2Financing = { notaryAmount: 0, totalValueWithNotary: 0, initialUserEquity: 0, loanAmount: 0, totalInterest: 0 };
            if (twoProjectsRadio.checked) {
                 p2Financing = updateFinancingCalculationsForProject(project2Elements, loanTermYearsSlider, notaryFeesPercentInput);
            }

            const inputs = {
                investmentYears: parseInt(investmentYearsSlider.value),
                loanTermYears: parseInt(loanTermYearsSlider.value),
                notaryFeesPercent: parseFloat(notaryFeesPercentInput.value) / 100,
                project1: getProjectInputData(project1Elements, p1Financing),
                project2: null,
                inflationRate: parseFloat(inflationRateInput.value) / 100,
                fpvRate: parseFloat(fpvRateInput.value) / 100,
                highYieldFundRate: parseFloat(highYieldFundRateInput.value) / 100,
                valuationScenarios: scenarioInputs.map(s => ({
                    name: s.name,
                    rate: parseFloat(s.slider.value) / 100,
                    color: s.color
                })),
                analyzeTwoProjects: twoProjectsRadio.checked
            };

            if (inputs.analyzeTwoProjects) {
                inputs.project2 = getProjectInputData(project2Elements, p2Financing);
            }

            let errors = [];
            if (isNaN(inputs.investmentYears) || inputs.investmentYears < 0) errors.push("Años de inversión debe ser un número no negativo.");
            if (isNaN(inputs.loanTermYears) || inputs.loanTermYears < 0) errors.push("Plazo Crédito debe ser un número no negativo.");

            if (isNaN(inputs.notaryFeesPercent) || inputs.notaryFeesPercent < 0 || inputs.notaryFeesPercent > 0.2) errors.push("Gastos de Notaría deben estar entre 0% y 20%.");

            const projectsToValidate = inputs.analyzeTwoProjects ? ['project1', 'project2'] : ['project1'];
            projectsToValidate.forEach(key => {
                const prop = inputs[key];
                if (!prop) return;
                const type = key === 'project1' ? 'Proyecto 1' : 'Proyecto 2';
                if (isNaN(prop.baseValue) || prop.baseValue <= 0 || !isFinite(prop.baseValue)) {
                    errors.push(`Valor inmueble (Base) (${type}) debe ser un número positivo y finito.`);
                }
                if (isNaN(prop.initialMonthlyRent) || prop.initialMonthlyRent < 0) errors.push(`Arriendo mensual (${type}) no puede ser negativo.`);
                if (isNaN(prop.propertyTaxPercent) || prop.propertyTaxPercent < 0) errors.push(`Impuesto Predial % (${type}) no puede ser negativo.`);
                if (isNaN(prop.maintenancePercent) || prop.maintenancePercent < 0) errors.push(`Mantenimiento % (${type}) no puede ser negativo.`);
                if (isNaN(prop.insurancePercent) || prop.insurancePercent < 0) errors.push(`Seguro de Vivienda % (${type}) no puede ser negativo.`);
                if (isNaN(prop.adminFeeMonthly) || prop.adminFeeMonthly < 0) errors.push(`Administración mensual (${type}) no puede ser negativa.`);
                if (isNaN(prop.downPaymentPercent) || prop.downPaymentPercent < 0 || prop.downPaymentPercent > 1) errors.push(`Porcentaje de entrada (${type}) debe estar entre 0% y 100%.`);
                if (isNaN(prop.creditRate) || prop.creditRate < 0 || prop.creditRate > 1) errors.push(`Tasa E.A. Crédito (${type}) debe estar entre 0% y 100%.`);
            });

            if (isNaN(inputs.inflationRate) || inputs.inflationRate < -1 || inputs.inflationRate > 1) errors.push("Inflación Estimada Anual debe estar entre -100% y 100%.");
            if (isNaN(inputs.fpvRate) || !isFinite(inputs.fpvRate) || inputs.fpvRate < -1 || inputs.fpvRate > 1) errors.push("Tasa FPV debe ser un número finito entre -100% y 100%.");
            if (isNaN(inputs.highYieldFundRate) || !isFinite(inputs.highYieldFundRate) || inputs.highYieldFundRate < -1 || inputs.highYieldFundRate > 1) errors.push("Tasa Fondo Alta Rentabilidad debe ser un número finito entre -100% y 100%.");

            inputs.valuationScenarios.forEach(scenario => {
                if (isNaN(scenario.rate)) errors.push(`Tasa para escenario ${scenario.name} debe ser un número válido.`);
            });

            if (errors.length > 0) {
                errorMessageDiv.innerHTML = errors.join("<br>");
                resultsArea.innerHTML = '';
                return null;
            }
            errorMessageDiv.textContent = '';
            return inputs;
        }

        function calculateRemainingLoanBalance(P, i, N, k, M_annual) {
            if (P <= 0) return 0;
            if (k >= N) return 0;
            if (N <= 0) return P;
            if (i === 0) return Math.max(0, P - (M_annual * k));

            let balance = P * Math.pow(1 + i, k) - M_annual * ( (Math.pow(1 + i, k) - 1) / i );
            return Math.max(0, balance);
        }

        function calculatePropertyMetrics(propertyInputData, generalInputs, valuationRate) {
            const baseValue = propertyInputData.baseValue;
            const initialUserEquity = propertyInputData.initialUserEquity;
            const loanAmount = propertyInputData.loanAmount;
            const creditRate = propertyInputData.creditRate;
            const initialMonthlyRent = propertyInputData.initialMonthlyRent;

            const propertyTaxPercent = propertyInputData.propertyTaxPercent;
            const maintenancePercent = propertyInputData.maintenancePercent;
            const insurancePercent = propertyInputData.insurancePercent;
            const initialAdminFeeAnnual = propertyInputData.adminFeeMonthly * 12;

            const investmentHorizonYears = generalInputs.investmentYears;
            const loanTermYears = generalInputs.loanTermYears;
            const inflationRate = generalInputs.inflationRate;

            const annualMortgagePayment = calculateAnnualMortgagePayment(loanAmount, creditRate, loanTermYears);

            let accumulatedCashFlow = 0;
            for (let year = 1; year <= investmentHorizonYears; year++) {
                const currentAnnualRent = (initialMonthlyRent * 12) * Math.pow(1 + inflationRate, year - 1);

                const currentPropertyValueBase = baseValue * Math.pow(1 + valuationRate, year -1);
                const currentPropertyTax = currentPropertyValueBase * propertyTaxPercent;
                const currentMaintenance = currentPropertyValueBase * maintenancePercent;
                const currentInsurance = currentPropertyValueBase * insurancePercent;
                const currentAdminFee = initialAdminFeeAnnual * Math.pow(1 + inflationRate, year - 1);

                const totalAnnualExpenses = currentPropertyTax + currentMaintenance + currentInsurance + currentAdminFee;

                const currentYearMortgagePayment = (year <= loanTermYears && loanAmount > 0) ? annualMortgagePayment : 0;

                const cashFlowThisYear = currentAnnualRent - totalAnnualExpenses - currentYearMortgagePayment;
                accumulatedCashFlow += cashFlowThisYear;
            }

            const futureBasePropertyValue = baseValue * Math.pow(1 + valuationRate, investmentHorizonYears);
            const remainingLoanBalance = calculateRemainingLoanBalance(loanAmount, creditRate, loanTermYears, investmentHorizonYears, annualMortgagePayment);

            const finalEquityInProperty = futureBasePropertyValue - remainingLoanBalance;
            const totalUserValue = finalEquityInProperty + accumulatedCashFlow;

            let roi = 0;
            let cagr = 0;

            if (initialUserEquity > 0) {
                roi = (totalUserValue - initialUserEquity) / initialUserEquity;
                if (investmentHorizonYears > 0) {
                    if (totalUserValue >= 0) {
                        cagr = Math.pow(totalUserValue / initialUserEquity, 1 / investmentHorizonYears) - 1;
                    } else {
                         cagr = -1;
                    }
                } else {
                     cagr = (totalUserValue / initialUserEquity) -1;
                     if (!isFinite(cagr)) cagr = 0;
                }
            } else if (initialUserEquity === 0) {
                if (totalUserValue > 0) {
                    roi = Infinity;
                    cagr = Infinity;
                } else if (totalUserValue < 0) {
                    roi = -Infinity;
                    cagr = -Infinity;
                } else {
                    roi = 0;
                    cagr = 0;
                }
            }

            const totalInterestOverLoanTerm = (annualMortgagePayment * loanTermYears) - loanAmount;

            return {
                futureBasePropertyValue,
                accumulatedCashFlow,
                finalEquityInProperty,
                totalUserValue,
                roi,
                cagr,
                initialUserEquity,
                annualMortgagePayment,
                totalInterestPaid: totalInterestOverLoanTerm > 0 ? totalInterestOverLoanTerm : 0
            };
        }

        function getAnnualCashFlowBreakdown(propertyInputData, generalInputs, valuationRateForExpenses) {
            const breakdown = [];
            const baseValue = propertyInputData.baseValue;
            const loanAmount = propertyInputData.loanAmount;
            const creditRate = propertyInputData.creditRate;

            const initialMonthlyRent = propertyInputData.initialMonthlyRent;

            const propertyTaxPercent = propertyInputData.propertyTaxPercent;
            const maintenancePercent = propertyInputData.maintenancePercent;
            const insurancePercent = propertyInputData.insurancePercent;
            const initialAdminFeeAnnual = propertyInputData.adminFeeMonthly * 12;

            const investmentHorizonYears = generalInputs.investmentYears;
            const loanTermYears = generalInputs.loanTermYears;
            const inflationRate = generalInputs.inflationRate;

            const annualMortgagePayment = calculateAnnualMortgagePayment(loanAmount, creditRate, loanTermYears);

            for (let year = 1; year <= investmentHorizonYears; year++) {
                const currentAnnualRentBruto = (initialMonthlyRent * 12) * Math.pow(1 + inflationRate, year - 1);

                const currentPropertyValueBase = baseValue * Math.pow(1 + valuationRateForExpenses, year - 1);
                const currentPropertyTax = currentPropertyValueBase * propertyTaxPercent;
                const currentMaintenance = currentPropertyValueBase * maintenancePercent;
                const currentInsurance = currentPropertyValueBase * insurancePercent;
                const currentAdminFee = initialAdminFeeAnnual * Math.pow(1 + inflationRate, year - 1);

                const gastosVariablesAnuales = currentPropertyTax + currentMaintenance + currentInsurance;
                const gastosFijosAnuales = currentAdminFee;
                const currentYearMortgagePayment = (year <= loanTermYears && loanAmount > 0) ? annualMortgagePayment : 0;

                const cashFlowNetoThisYear = currentAnnualRentBruto - gastosVariablesAnuales - gastosFijosAnuales - currentYearMortgagePayment;
                breakdown.push({
                    year: year,
                    annualRentBruto: currentAnnualRentBruto,
                    gastosVariablesAnuales: gastosVariablesAnuales,
                    gastosFijosAnuales: gastosFijosAnuales,
                    annualMortgagePayment: currentYearMortgagePayment,
                    cashFlowNetoAnual: cashFlowNetoThisYear
                });
            }
            return breakdown;
        }


        function calculateLiquidInstrumentValue(principal, rate, years) {
            if (principal === 0) return 0;
            if (!isFinite(principal) || !isFinite(rate) || !isFinite(years)) return NaN;
            if (years < 0) return principal;
            return principal * Math.pow(1 + rate, years);
        }

        function displayResults() {
            const inputs = getAndValidateInputs();
            if (!inputs) return;

            resultsArea.innerHTML = '';

            const projectsToDisplay = [];
            if (inputs.project1 && inputs.project1.baseValue > 0 && isFinite(inputs.project1.baseValue)) {
                 projectsToDisplay.push({
                    name: "Proyecto 1",
                    idPrefix: "project1",
                    inputData: inputs.project1
                });
            }
            if (inputs.analyzeTwoProjects && inputs.project2 && inputs.project2.baseValue > 0 && isFinite(inputs.project2.baseValue)) {
                 projectsToDisplay.push({
                    name: "Proyecto 2",
                    idPrefix: "project2",
                    inputData: inputs.project2
                });
            }

            const FINANCIAL_INSTRUMENTS = [
                { name: "FPV", displayName: "FPV (Fondo de Pensiones Voluntarias)", rate: inputs.fpvRate, id: "fpv" },
                { name: "FondoAltaRent", displayName: "Fondo de Alta Rentabilidad", rate: inputs.highYieldFundRate, id: "high_yield_fund" }
            ];

            const propertyMetricsStore = {};

            projectsToDisplay.forEach(propSetup => {
                const propertyInputData = propSetup.inputData;
                propertyMetricsStore[propSetup.idPrefix] = [];

                let projectSummaryHtml = `<div class="summary-block">`;
                projectSummaryHtml += `<h4>Resumen de Compra y Financiamiento: ${propSetup.name}</h4>`;
                projectSummaryHtml += `<ul>`;
                projectSummaryHtml += `<li><strong>Valor Base Inmueble:</strong> <span class="value">${copFormatter.format(propertyInputData.baseValue)}</span></li>`;
                projectSummaryHtml += `<li><strong>Gastos Notaría y Reg. (${percentFormatter(inputs.notaryFeesPercent,1)}):</strong> <span class="value">${copFormatter.format(propertyInputData.notaryAmount)}</span></li>`;
                projectSummaryHtml += `<li><strong>Valor Total Adquisición (con Notaría):</strong> <span class="value">${copFormatter.format(propertyInputData.totalValueWithNotary)}</span></li>`;
                projectSummaryHtml += `</ul>`;
                projectSummaryHtml += `<h5 class="font-semibold text-gray-700 mt-2 mb-1">Detalles del Financiamiento:</h5>`;
                projectSummaryHtml += `<ul class="list-disc list-inside ml-4">`;
                projectSummaryHtml += `<li><strong>Enganche (${percentFormatter(propertyInputData.downPaymentPercent,0)}):</strong> <span class="value">${copFormatter.format(propertyInputData.initialUserEquity)}</span></li>`;
                projectSummaryHtml += `<li><strong>Monto del Crédito:</strong> <span class="value">${copFormatter.format(propertyInputData.loanAmount)}</span></li>`;
                projectSummaryHtml += `<li><strong>Tasa E.A. Crédito:</strong> <span class="value">${percentFormatter(propertyInputData.creditRate,2)}</span></li>`;
                projectSummaryHtml += `<li><strong>Plazo del Crédito:</strong> <span class="value">${inputs.loanTermYears} años</span></li>`;
                const annualMortgagePaymentForSummary = calculateAnnualMortgagePayment(propertyInputData.loanAmount, propertyInputData.creditRate, inputs.loanTermYears);
                const totalInterestForSummary = (annualMortgagePaymentForSummary * inputs.loanTermYears) - propertyInputData.loanAmount;
                projectSummaryHtml += `<li><strong>Pago Anual Estimado (Crédito):</strong> <span class="value">${copFormatter.format(annualMortgagePaymentForSummary)}</span></li>`;
                projectSummaryHtml += `<li><strong>Intereses Totales Estimados (sobre Plazo Total Crédito):</strong> <span class="value">${copFormatter.format(totalInterestForSummary > 0 ? totalInterestForSummary : 0)}</span></li>`;
                projectSummaryHtml += `</ul>`;
                projectSummaryHtml += `<p class="note">Nota: El "Flujo Caja Neto Acum." en la tabla de resultados considera los pagos del crédito y gastos operativos (que varían por escenario) durante los ${inputs.investmentYears} años de inversión.</p>`;
                projectSummaryHtml += `</div>`;


                let propertyHtml = `<section id="${propSetup.idPrefix}-analysis" class="mb-10">`;
                propertyHtml += `<h2 class="section-title">${propSetup.name}</h2>`;
                propertyHtml += projectSummaryHtml;

                propertyHtml += `<div class="overflow-x-auto"><table class="custom-table">`;
                propertyHtml += `
                    <thead>
                        <tr>
                            <th>Escenario Valorización</th>
                            <th>Valor Futuro Inmueble (Base Apreciada)</th>
                            <th>Flujo Caja Neto Acum. (Post-Hipoteca)</th>
                            <th>Patrimonio Final Usuario</th>
                            <th>ROI Neto (s/Enganche)</th>
                            <th>CAGR (s/Enganche)</th>
                        </tr>
                    </thead>
                    <tbody>`;

                inputs.valuationScenarios.forEach(scenario => {
                    const metrics = calculatePropertyMetrics(propertyInputData, inputs, scenario.rate);
                    propertyMetricsStore[propSetup.idPrefix].push({
                        scenarioName: scenario.name,
                        scenarioColor: scenario.color,
                        totalUserValue: metrics.totalUserValue,
                        scenarioRate: scenario.rate,
                        initialUserEquity: metrics.initialUserEquity
                    });

                    propertyHtml += `
                        <tr>
                            <td class="font-semibold ${scenario.color}">${scenario.name} (${percentFormatter(scenario.rate, 1)})</td>
                            <td>${copFormatter.format(metrics.futureBasePropertyValue)}</td>
                            <td>${copFormatter.format(metrics.accumulatedCashFlow)}</td>
                            <td class="font-bold">${copFormatter.format(metrics.totalUserValue)}</td>
                            <td class="font-semibold ${metrics.roi >= 0 ? 'text-green-700' : 'text-red-700'}">${percentFormatter(metrics.roi)}</td>
                            <td class="font-semibold ${!isFinite(metrics.cagr) || metrics.cagr >= 0 ? 'text-green-700' : 'text-red-700'}">${percentFormatter(metrics.cagr)}</td>
                        </tr>`;
                });
                propertyHtml += `</tbody></table></div>`;

                let representativeScenarioRate = inputs.valuationScenarios.find(s => s.name === "Realista")?.rate;
                if (representativeScenarioRate === undefined && inputs.valuationScenarios.length > 0) {
                    representativeScenarioRate = inputs.valuationScenarios[0].rate;
                } else if (representativeScenarioRate === undefined) {
                    representativeScenarioRate = 0;
                }

                propertyHtml += `<div id="${propSetup.idPrefix}-annual-cashflow-container" class="mt-6">`;
                const annualBreakdown = getAnnualCashFlowBreakdown(propertyInputData, inputs, representativeScenarioRate);
                propertyHtml += `<h5 class="table-title">Desglose Anual del Flujo de Caja para ${propSetup.name} (usando escenario de valorización: ${percentFormatter(representativeScenarioRate,1)})</h5>`;
                propertyHtml += `<div class="overflow-x-auto"><table class="custom-table" id="${propSetup.idPrefix}-annual-cashflow-table">`;
                propertyHtml += `
                    <thead>
                        <tr>
                            <th>Año</th>
                            <th>Arriendo Anual Bruto</th>
                            <th>Gastos Variables Anuales (Predial + Mant. + Seguro)</th>
                            <th>Gastos Fijos Anuales (Admin)</th>
                            <th>Pago Anual Crédito</th>
                            <th>Flujo de Caja Neto Anual</th>
                        </tr>
                    </thead>
                    <tbody>`;
                let totalNetAnnualCashFlow = 0;
                annualBreakdown.forEach(item => {
                    totalNetAnnualCashFlow += item.cashFlowNetoAnual;
                    propertyHtml += `
                        <tr>
                            <td>${item.year}</td>
                            <td>${copFormatter.format(item.annualRentBruto)}</td>
                            <td>${copFormatter.format(item.gastosVariablesAnuales)}</td>
                            <td>${copFormatter.format(item.gastosFijosAnuales)}</td>
                            <td>${copFormatter.format(item.annualMortgagePayment)}</td>
                            <td class="${item.cashFlowNetoAnual >= 0 ? 'text-green-700' : 'text-red-700'} font-semibold">${copFormatter.format(item.cashFlowNetoAnual)}</td>
                        </tr>`;
                });
                propertyHtml += `</tbody>`;
                propertyHtml += `
                    <tfoot>
                        <tr class="bg-gray-100 font-semibold">
                            <td colspan="5" class="text-right pr-4">Total Flujo de Caja Neto Acumulado:</td>
                            <td class="${totalNetAnnualCashFlow >= 0 ? 'text-green-700' : 'text-red-700'}">${copFormatter.format(totalNetAnnualCashFlow)}</td>
                        </tr>
                    </tfoot>`;
                propertyHtml += `</table></div></div>`;

                propertyHtml += `</section>`;
                resultsArea.innerHTML += propertyHtml;
            });

            if (projectsToDisplay.length > 0) {
                let liquidInstrumentsHtml = `<section id="liquid-instruments-analysis" class="mb-10">`;
                liquidInstrumentsHtml += `<h2 class="section-title">Proyección Instrumentos Financieros (Invirtiendo el Enganche)</h2>`;

                projectsToDisplay.forEach(propSetup => {
                    const propertyInputData = propSetup.inputData;
                    liquidInstrumentsHtml += `<h3 class="subsection-title">Si invirtiera ${copFormatter.format(propertyInputData.initialUserEquity)} (Enganche de ${propSetup.name}) en:</h3>`;
                    liquidInstrumentsHtml += `<div class="overflow-x-auto"><table class="custom-table">`;
                    liquidInstrumentsHtml += `
                        <thead>
                            <tr>
                                <th>Instrumento Financiero</th>
                                <th>Valor Futuro Estimado</th>
                                <th>Tasa Efectiva Anual (CAGR)</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    FINANCIAL_INSTRUMENTS.forEach(instrument => {
                        const futureValue = calculateLiquidInstrumentValue(propertyInputData.initialUserEquity, instrument.rate, inputs.investmentYears);
                        liquidInstrumentsHtml += `
                            <tr>
                                <td class="font-semibold">${instrument.displayName}</td>
                                <td class="font-bold">${copFormatter.format(futureValue)}</td>
                                <td class="font-semibold text-blue-700">${percentFormatter(instrument.rate, 2)}</td>
                            </tr>`;
                    });
                    liquidInstrumentsHtml += `</tbody></table></div>`;
                });
                liquidInstrumentsHtml += `</section>`;
                resultsArea.innerHTML += liquidInstrumentsHtml;

                let directComparisonHtml = `<section id="direct-comparison-analysis" class="mb-10">`;
                directComparisonHtml += `<h2 class="section-title">Comparación Directa: Patrimonio Final Usuario (Inmueble vs. Instrumentos Líquidos)</h2>`;

                projectsToDisplay.forEach(propSetup => {
                    const propertyInputData = propSetup.inputData;
                    if (!propertyMetricsStore[propSetup.idPrefix] || propertyMetricsStore[propSetup.idPrefix].length === 0) return;

                    const storedMetricsForProperty = propertyMetricsStore[propSetup.idPrefix];
                    const initialEquityForComparison = storedMetricsForProperty[0].initialUserEquity;


                    directComparisonHtml += `<h3 class="subsection-title">Comparativa para ${propSetup.name} (Enganche Invertido: ${copFormatter.format(initialEquityForComparison)})</h3>`;
                    directComparisonHtml += `<div class="overflow-x-auto"><table class="custom-table">`;
                    directComparisonHtml += `
                        <thead>
                            <tr>
                                <th>Escenario Valorización Inmueble</th>
                                <th>Patrimonio Final Usuario (Inmueble)</th>
                                <th>Valor Futuro FPV</th>
                                <th>Diferencia (Inmueble - FPV)</th>
                                <th>Valor Futuro Fondo Alta Rent.</th>
                                <th>Diferencia (Inmueble - Fondo A.R.)</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    const fpvData = FINANCIAL_INSTRUMENTS.find(inst => inst.id === 'fpv');
                    const highYieldData = FINANCIAL_INSTRUMENTS.find(inst => inst.id === 'high_yield_fund');

                    const fpvFutureValue = fpvData ? calculateLiquidInstrumentValue(initialEquityForComparison, fpvData.rate, inputs.investmentYears) : 0;
                    const highYieldFutureValue = highYieldData ? calculateLiquidInstrumentValue(initialEquityForComparison, highYieldData.rate, inputs.investmentYears) : 0;

                    storedMetricsForProperty.forEach(metric => {
                        const diffFpv = metric.totalUserValue - fpvFutureValue;
                        const diffHighYield = metric.totalUserValue - highYieldFutureValue;

                        directComparisonHtml += `
                            <tr>
                                <td class="font-semibold ${metric.scenarioColor}">${metric.scenarioName} (${percentFormatter(metric.scenarioRate,1)})</td>
                                <td class="font-bold">${copFormatter.format(metric.totalUserValue)}</td>
                                <td>${fpvData && isFinite(fpvFutureValue) ? copFormatter.format(fpvFutureValue) : 'N/A'}</td>
                                <td class="${diffFpv >= 0 ? 'positive-diff' : 'negative-diff'}">${isFinite(diffFpv) ? copFormatter.format(diffFpv) : 'N/A'}</td>
                                <td>${highYieldData && isFinite(highYieldFutureValue) ? copFormatter.format(highYieldFutureValue) : 'N/A'}</td>
                                <td class="${diffHighYield >= 0 ? 'positive-diff' : 'negative-diff'}">${isFinite(diffHighYield) ? copFormatter.format(diffHighYield) : 'N/A'}</td>
                            </tr>`;
                    });
                    directComparisonHtml += `</tbody></table></div>`;
                });
                directComparisonHtml += `</section>`;
                resultsArea.innerHTML += directComparisonHtml;
            }
        }

        // Función para inicializar los valores de los inputs desde la configuración externa
        function setInputsFromConfig() {
            if (!window.REIT_CONFIG) return;
            const cfg = window.REIT_CONFIG;
            // Proyecto 1
            project1Elements.baseValueInput.value = cfg.project1.baseValue;
            project1Elements.initialMonthlyRentInput.value = cfg.project1.initialMonthlyRent;
            project1Elements.propertyTaxPercentInput.value = cfg.project1.propertyTaxPercent;
            project1Elements.maintenancePercentInput.value = cfg.project1.maintenancePercent;
            project1Elements.insurancePercentInput.value = cfg.project1.insurancePercent;
            project1Elements.adminFeeMonthlyInput.value = cfg.project1.adminFeeMonthly;
            project1Elements.downPaymentPercentInput.value = cfg.project1.downPaymentPercent;
            project1Elements.creditRateInput.value = cfg.project1.creditRate;
            // Proyecto 2
            project2Elements.baseValueInput.value = cfg.project2.baseValue;
            project2Elements.initialMonthlyRentInput.value = cfg.project2.initialMonthlyRent;
            project2Elements.propertyTaxPercentInput.value = cfg.project2.propertyTaxPercent;
            project2Elements.maintenancePercentInput.value = cfg.project2.maintenancePercent;
            project2Elements.insurancePercentInput.value = cfg.project2.insurancePercent;
            project2Elements.adminFeeMonthlyInput.value = cfg.project2.adminFeeMonthly;
            project2Elements.downPaymentPercentInput.value = cfg.project2.downPaymentPercent;
            project2Elements.creditRateInput.value = cfg.project2.creditRate;
            // Generales
            investmentYearsSlider.value = cfg.general.investmentYears;
            loanTermYearsSlider.value = cfg.general.loanTermYears;
            notaryFeesPercentInput.value = cfg.general.notaryFeesPercent;
            inflationRateInput.value = cfg.general.inflationRate;
            fpvRateInput.value = cfg.general.fpvRate;
            highYieldFundRateInput.value = cfg.general.highYieldFundRate;
            // Escenarios
            scenarioInputs[0].slider.value = cfg.scenarios.pessimistic;
            scenarioInputs[1].slider.value = cfg.scenarios.normal;
            scenarioInputs[2].slider.value = cfg.scenarios.realistic;
            scenarioInputs[3].slider.value = cfg.scenarios.optimistic;
            // Actualizar displays
            scenarioInputs.forEach(scenario => updateSliderValueDisplay(scenario.slider, scenario.valueDisplay, scenario.decimals));
            updateSliderValueDisplay(investmentYearsSlider, investmentYearsValue, 0, ' años');
            updateSliderValueDisplay(loanTermYearsSlider, loanTermYearsValue, 0, ' años');
            triggerFinancingCalculationsUpdate();
        }
        // Botón de reset
        const resetButton = document.getElementById('resetButton');
        resetButton.addEventListener('click', () => {
            setInputsFromConfig();
            displayResults();
        });
        // Inicializar valores al cargar
        document.addEventListener('DOMContentLoaded', () => {
            setInputsFromConfig();
            if (oneProjectRadio.checked) {
                project2Elements.block.classList.add('hidden-section');
                generalFinancialBlock.classList.remove('lg:col-start-3');
            } else {
                 project2Elements.block.classList.remove('hidden-section');
                 generalFinancialBlock.classList.add('lg:col-start-3');
            }
            triggerFinancingCalculationsUpdate();
            displayResults();
        });

        calculateButton.addEventListener('click', displayResults);
    </script>
</body>
</html>
